# Connect4 Position Counter

This project is an open-source implementation of the approach described in
```
Edelkamp, S., & Kissmann, P. (2011, August). On the complexity of BDDs for state space search: A case study in Connect Four.
In Proceedings of the AAAI Conference on Artificial Intelligence (Vol. 25, No. 1, pp. 18-23).
```
to determinte the number of unique positions in a Connect4 game of a given board size.

The number of positions for the conventional 7 x 6 board can be computed in ~3h with 14GB RAM (log2tbsize=28).

## Usage

Compile with `make` (see the `src/makefile` for compilation options):
```
cd src
make
```

Run with
```
connect4.out log2tbsize width height
```
`log2tbsize` is the parameter that controls how much RAM is used and how many BDD nodes can be allocated (`1 << log2tbsize`).
The maximum size is `log2tbsize=32` which requires a bit more than 200GB RAM.
It is recommended to set `log2tbsize` as large as possible, because it reduces hash collisions.

Garbage collection was tuned to work well with `connect4.out 29 7 6`.  
Smaller board sizes spend more time in GC than necessary.

### Queens
We also inlcude an implementation of the [n-queens puzzle](https://en.wikipedia.org/wiki/Eight_queens_puzzle).

Compile it with `make queens` and run  with `queens.out log2tbsize N`.  E.g. `queens.out 22 8` or `queens.out 27 12`.  
You may play around with trading of speed versus memory usage.

### Writing your own program

This project comes with its own [binary decision diagram](https://en.wikipedia.org/wiki/Binary_decision_diagram) library implementation.
Its focus is on pre-allocation of all BDD nodes (constant memory usage), fine control over garbage collection, and to make Connect4 work.
So it may not be the most user-friendly BDD library, however, it is very performant and may be re-used for your needs.
We do not provide documentation, but comments in the source code and studying `queens.c` and `connect.c` should help.

## Results
We were able to independently verify the numbers computed by [John Tromp](https://tromp.github.io/c4/c4.html) and produce novel counts for boards up to size `width + height = 14`.

The computation were run on a Intel(R) Xeon(R) Platinum 8358 CPU @ 2.60GHz with 238.4GB RAM.


|   height/width |   1 |       2 |             3 |              4 |                 5 |                  6 |                   7 |                   8 |                   9 |                 10 |              11 |            12 |      13 |
|---------------:|----:|--------:|--------------:|---------------:|------------------:|-------------------:|--------------------:|--------------------:|--------------------:|-------------------:|----------------:|--------------:|--------:|
|              1 |   2 |       5 |            13 |             35 |                96 |                267 |                 750 |               2,118 |               6,010 |             17,120 |          48,930 |       140,243 | 402,956 |
|              2 |   3 |      18 |           116 |            741 |             4,688 |             29,737 |             189,648 |           1,216,721 |           7,844,298 |         50,780,523 |     329,842,064 | 2,148,495,091 |     N/A |
|              3 |   4 |      58 |           869 |         12,031 |           158,911 |          2,087,325 |          27,441,956 |         362,940,958 |       4,816,325,017 |     64,137,689,503 | 856,653,299,180 |           N/A |     N/A |
|              4 |   5 |     179 |         6,000 |        161,029 |         3,945,711 |         94,910,577 |       2,265,792,710 |      54,233,186,631 |   1,295,362,125,552 | 30,932,968,221,097 |             N/A |           N/A |     N/A |
|              5 |   6 |     537 |        38,310 |      1,706,255 |        69,763,700 |      2,818,972,642 |     112,829,665,923 |   4,499,431,376,127 | 178,942,601,291,926 |                N/A |             N/A |           N/A |     N/A |
|              6 |   7 |   1,571 |       235,781 |     15,835,683 |     1,044,334,437 |     69,173,028,785 |   4,531,985,219,092 | 290,433,534,225,566 |                 N/A |                N/A |             N/A |           N/A |     N/A |
|              7 |   8 |   4,587 |     1,417,322 |    135,385,909 |    14,171,315,454 |  1,523,281,696,228 | 161,965,120,344,045 |                 N/A |                 N/A |                N/A |             N/A |           N/A |     N/A |
|              8 |   9 |  13,343 |     8,424,616 |  1,104,642,469 |   182,795,971,462 | 31,936,554,362,084 |                 N/A |                 N/A |                 N/A |                N/A |             N/A |           N/A |     N/A |
|              9 |  10 |  38,943 |    49,867,996 |  8,754,703,921 | 2,284,654,770,108 |                N/A |                 N/A |                 N/A |                 N/A |                N/A |             N/A |           N/A |     N/A |
|             10 |  11 | 113,835 |   294,664,010 | 67,916,896,758 |               N/A |                N/A |                 N/A |                 N/A |                 N/A |                N/A |             N/A |           N/A |     N/A |
|             11 |  12 | 333,745 | 1,741,288,730 |            N/A |               N/A |                N/A |                 N/A |                 N/A |                 N/A |                N/A |             N/A |           N/A |     N/A |
|             12 |  13 | 980,684 |           N/A |            N/A |               N/A |                N/A |                 N/A |                 N/A |                 N/A |                N/A |             N/A |           N/A |     N/A |
|             13 |  14 |     N/A |           N/A |            N/A |               N/A |                N/A |                 N/A |                 N/A |                 N/A |                N/A |             N/A |           N/A |     N/A |

### Counts per ply

By default, we only construct one BDD per ply (layer).
We record the number of positions at a given ply and the number of nodes of the BDD encoding these positions.
These numbers can be found in the results folder.

In the 7 x 6 case, our approximately numbers match Edelkamp, S., & Kissmann, P.

We also implemented the compilation option `FULLBDD=1` which computes the OR over the BDDs of each ply.
This encodes all Connect4 positions.
For the 7 x 6 position this BDD has 95124612 nodes in our implementation.

This is a bit much more than the 84,088,763 number of nodes which Edelkamp, S., & Kissmann, P. claimed in 
```
Edelkamp, S., & Kissmann, P. (2008). Symbolic classification of general two-player games.
In KI 2008: Advances in Artificial Intelligence: 31st Annual German Conference on AI, KI 2008, Kaiserslautern, Germany, September 23-26, 2008. Proceedings 31 (pp. 185-192). Springer Berlin Heidelberg.
```
Of course this number depends on the variable ordering which Edelkamp, S., & Kissmann, P. did not publish.

### Experiment information
|   width |   height |          #positions |          comp.time |   GC perc. |   RAM used |   #allocatable |    #allocated |   perc. allocated |
|--------:|---------:|--------------------:|-------------------:|-----------:|-----------:|---------------:|--------------:|------------------:|
|       1 |        1 |                   2 |         0:00:00.67 |     27.48% |     6.85GB |           2^27 |            61 |             0.00% |
|       1 |        2 |                   3 |         0:00:00.74 |     24.62% |     6.85GB |           2^27 |           222 |             0.00% |
|       1 |        3 |                   4 |         0:00:00.81 |     22.77% |     6.85GB |           2^27 |           468 |             0.00% |
|       1 |        4 |                   5 |         0:00:00.88 |     21.23% |     6.85GB |           2^27 |           825 |             0.00% |
|       1 |        5 |                   6 |         0:00:00.94 |     19.36% |     6.85GB |           2^27 |         1,306 |             0.00% |
|       1 |        6 |                   7 |         0:00:01.01 |     18.00% |     6.85GB |           2^27 |         1,923 |             0.00% |
|       1 |        7 |                   8 |         0:00:01.08 |     16.92% |     6.85GB |           2^27 |         2,688 |             0.00% |
|       1 |        8 |                   9 |         0:00:01.15 |     15.79% |     6.85GB |           2^27 |         3,613 |             0.00% |
|       1 |        9 |                  10 |         0:00:01.60 |     34.47% |     6.85GB |           2^27 |         4,710 |             0.00% |
|       1 |       10 |                  11 |         0:00:02.02 |     45.06% |     6.85GB |           2^27 |         5,991 |             0.00% |
|       1 |       11 |                  12 |         0:00:02.47 |     52.25% |     6.85GB |           2^27 |         7,468 |             0.01% |
|       1 |       12 |                  13 |         0:00:12.27 |     57.63% |    27.38GB |           2^29 |         9,153 |             0.00% |
|       1 |       13 |                  14 |         0:00:26.77 |     60.75% |    54.76GB |           2^30 |        11,058 |             0.00% |
|       2 |        1 |                   5 |         0:00:00.73 |     24.67% |     6.85GB |           2^27 |           203 |             0.00% |
|       2 |        2 |                  18 |         0:00:00.87 |     20.94% |     6.85GB |           2^27 |           800 |             0.00% |
|       2 |        3 |                  58 |         0:00:01.02 |     17.93% |     6.85GB |           2^27 |         1,957 |             0.00% |
|       2 |        4 |                 179 |         0:00:01.16 |     15.91% |     6.85GB |           2^27 |         3,777 |             0.00% |
|       2 |        5 |                 537 |         0:00:02.02 |     45.05% |     6.85GB |           2^27 |         6,330 |             0.00% |
|       2 |        6 |               1,571 |         0:00:02.91 |     56.82% |     6.85GB |           2^27 |         9,700 |             0.01% |
|       2 |        7 |               4,587 |         0:00:03.82 |     63.13% |     6.85GB |           2^27 |        13,971 |             0.01% |
|       2 |        8 |              13,343 |         0:00:04.78 |     66.98% |     6.85GB |           2^27 |        19,227 |             0.01% |
|       2 |        9 |              38,943 |         0:00:05.69 |     69.59% |     6.85GB |           2^27 |        25,552 |             0.02% |
|       2 |       10 |             113,835 |         0:00:06.77 |     71.62% |     6.85GB |           2^27 |        33,030 |             0.02% |
|       2 |       11 |             333,745 |         0:00:30.29 |     73.50% |    27.38GB |           2^29 |        41,745 |             0.01% |
|       2 |       12 |             980,684 |         0:01:06.19 |     74.78% |    54.76GB |           2^30 |        51,781 |             0.00% |
|       3 |        1 |                  13 |         0:00:00.87 |     22.92% |     6.85GB |           2^27 |           426 |             0.00% |
|       3 |        2 |                 116 |         0:00:01.04 |     18.44% |     6.85GB |           2^27 |         1,836 |             0.00% |
|       3 |        3 |                 869 |         0:00:01.44 |     26.32% |     6.85GB |           2^27 |         4,567 |             0.00% |
|       3 |        4 |               6,000 |         0:00:03.01 |     57.20% |     6.85GB |           2^27 |        10,781 |             0.01% |
|       3 |        5 |              38,310 |         0:00:04.53 |     65.07% |     6.85GB |           2^27 |        18,520 |             0.01% |
|       3 |        6 |             235,781 |         0:00:05.80 |     68.64% |     6.85GB |           2^27 |        29,974 |             0.02% |
|       3 |        7 |           1,417,322 |         0:00:07.36 |     68.99% |     6.85GB |           2^27 |        75,162 |             0.06% |
|       3 |        8 |           8,424,616 |         0:00:09.67 |     67.38% |     6.85GB |           2^27 |       172,756 |             0.13% |
|       3 |        9 |          49,867,996 |         0:00:14.60 |     62.21% |     6.85GB |           2^27 |       422,983 |             0.32% |
|       3 |       10 |         294,664,010 |         0:01:09.28 |     67.59% |    27.38GB |           2^29 |     1,010,556 |             0.19% |
|       3 |       11 |       1,741,288,730 |         0:02:38.47 |     66.14% |    54.76GB |           2^30 |     2,381,296 |             0.22% |
|       4 |        1 |                  35 |         0:00:00.88 |     20.84% |     6.85GB |           2^27 |           745 |             0.00% |
|       4 |        2 |                 741 |         0:00:01.17 |     15.98% |     6.85GB |           2^27 |         3,426 |             0.00% |
|       4 |        3 |              12,031 |         0:00:02.91 |     56.68% |     6.85GB |           2^27 |         8,853 |             0.01% |
|       4 |        4 |             161,029 |         0:00:09.31 |     82.53% |     6.85GB |           2^27 |        17,799 |             0.01% |
|       4 |        5 |           1,706,255 |         0:00:13.97 |     80.92% |     6.85GB |           2^27 |       129,589 |             0.10% |
|       4 |        6 |          15,835,683 |         0:00:22.41 |     71.30% |     6.85GB |           2^27 |       561,346 |             0.42% |
|       4 |        7 |         135,385,909 |         0:00:43.05 |     52.97% |     6.85GB |           2^27 |     1,648,551 |             1.23% |
|       4 |        8 |       1,104,642,469 |         0:01:43.80 |     32.62% |     6.85GB |           2^27 |     4,307,162 |             3.21% |
|       4 |        9 |       8,754,703,921 |         0:07:13.75 |     36.64% |    27.38GB |           2^29 |    11,478,742 |             2.14% |
|       4 |       10 |      67,916,896,758 |         0:21:19.35 |     30.47% |    54.76GB |           2^30 |    29,923,914 |             2.79% |
|       5 |        1 |                  96 |         0:00:00.95 |     19.58% |     6.85GB |           2^27 |         1,172 |             0.00% |
|       5 |        2 |               4,688 |         0:00:02.02 |     45.08% |     6.85GB |           2^27 |         5,666 |             0.00% |
|       5 |        3 |             158,911 |         0:00:04.33 |     65.09% |     6.85GB |           2^27 |        15,062 |             0.01% |
|       5 |        4 |           3,945,711 |         0:00:14.31 |     82.08% |     6.85GB |           2^27 |       129,415 |             0.10% |
|       5 |        5 |          69,763,700 |         0:00:28.89 |     62.67% |     6.85GB |           2^27 |     1,230,084 |             0.92% |
|       5 |        6 |       1,044,334,437 |         0:02:31.63 |     24.05% |     6.85GB |           2^27 |     8,235,134 |             6.14% |
|       5 |        7 |      14,171,315,454 |         0:10:33.32 |     14.14% |     6.85GB |           2^27 |    25,600,589 |            19.07% |
|       5 |        8 |     182,795,971,462 |         0:43:21.22 |     14.76% |    27.38GB |           2^29 |    69,165,125 |            12.88% |
|       5 |        9 |   2,284,654,770,108 |         3:01:45.83 |     14.94% |   109.52GB |           2^31 |   201,469,478 |             9.38% |
|       6 |        1 |                 267 |         0:00:01.03 |     18.24% |     6.85GB |           2^27 |         1,719 |             0.00% |
|       6 |        2 |              29,737 |         0:00:03.02 |     57.38% |     6.85GB |           2^27 |         8,652 |             0.01% |
|       6 |        3 |           2,087,325 |         0:00:05.80 |     68.28% |     6.85GB |           2^27 |        32,107 |             0.02% |
|       6 |        4 |          94,910,577 |         0:00:24.33 |     70.16% |     6.85GB |           2^27 |       706,477 |             0.53% |
|       6 |        5 |       2,818,972,642 |         0:02:17.06 |     28.26% |     6.85GB |           2^27 |     7,852,100 |             5.85% |
|       6 |        6 |      69,173,028,785 |         0:26:54.42 |     13.25% |     6.85GB |           2^27 |    61,634,539 |            45.92% |
|       6 |        7 |   1,523,281,696,228 |         4:49:49.95 |      8.94% |    27.38GB |           2^29 |   365,099,251 |            68.01% |
|       6 |        8 |  31,936,554,362,084 |        19:05:58.63 |     10.03% |   109.52GB |           2^31 | 1,023,026,899 |            47.64% |
|       7 |        1 |                 750 |         0:00:01.10 |     17.32% |     6.85GB |           2^27 |         2,398 |             0.00% |
|       7 |        2 |             189,648 |         0:00:03.89 |     63.26% |     6.85GB |           2^27 |        12,480 |             0.01% |
|       7 |        3 |          27,441,956 |         0:00:07.59 |     68.44% |     6.85GB |           2^27 |        97,803 |             0.07% |
|       7 |        4 |       2,265,792,710 |         0:00:55.87 |     49.33% |     6.85GB |           2^27 |     2,418,545 |             1.80% |
|       7 |        5 |     112,829,665,923 |         0:12:39.10 |     16.95% |     6.85GB |           2^27 |    27,594,037 |            20.56% |
|       7 |        6 |   4,531,985,219,092 |         3:19:39.28 |     12.56% |    27.38GB |           2^29 |   238,538,432 |            44.43% |
|       7 |        7 | 161,965,120,344,045 | 1 day, 22:15:50.00 |     10.66% |   109.52GB |           2^31 | 1,797,440,896 |            83.70% |
|       8 |        1 |               2,118 |         0:00:01.19 |     16.52% |     6.85GB |           2^27 |         3,221 |             0.00% |
|       8 |        2 |           1,216,721 |         0:00:04.89 |     67.05% |     6.85GB |           2^27 |        17,246 |             0.01% |
|       8 |        3 |         362,940,958 |         0:00:09.66 |     64.10% |     6.85GB |           2^27 |       238,318 |             0.18% |
|       8 |        4 |      54,233,186,631 |         0:02:35.56 |     31.73% |     6.85GB |           2^27 |     5,820,061 |             4.34% |
|       8 |        5 |   4,499,431,376,127 |         0:54:34.82 |     18.28% |    27.38GB |           2^29 |    70,093,438 |            13.06% |
|       8 |        6 | 290,433,534,225,566 |        17:06:50.59 |     11.63% |    54.76GB |           2^30 |   625,763,115 |            58.28% |
|       9 |        1 |               6,010 |         0:00:01.63 |     35.18% |     6.85GB |           2^27 |         4,200 |             0.00% |
|       9 |        2 |           7,844,298 |         0:00:05.83 |     69.04% |     6.85GB |           2^27 |        23,046 |             0.02% |
|       9 |        3 |       4,816,325,017 |         0:00:13.50 |     56.83% |     6.85GB |           2^27 |       478,748 |             0.36% |
|       9 |        4 |   1,295,362,125,552 |         0:09:14.50 |     40.31% |    27.38GB |           2^29 |    11,398,845 |             2.12% |
|       9 |        5 | 178,942,601,291,926 |         2:58:41.23 |     16.62% |    54.76GB |           2^30 |   163,165,045 |            15.20% |
|      10 |        1 |              17,120 |         0:00:02.08 |     45.90% |     6.85GB |           2^27 |         5,347 |             0.00% |
|      10 |        2 |          50,780,523 |         0:00:06.87 |     70.01% |     6.85GB |           2^27 |        36,276 |             0.03% |
|      10 |        3 |      64,137,689,503 |         0:00:51.52 |     63.88% |    27.38GB |           2^29 |       840,337 |             0.16% |
|      10 |        4 |  30,932,968,221,097 |         0:24:05.94 |     40.29% |    54.76GB |           2^30 |    24,226,909 |             2.26% |
|      11 |        1 |              48,930 |         0:00:02.55 |     52.75% |     6.85GB |           2^27 |         6,674 |             0.00% |
|      11 |        2 |         329,842,064 |         0:00:30.24 |     72.48% |    27.38GB |           2^29 |        57,846 |             0.01% |
|      11 |        3 |     856,653,299,180 |         0:01:57.51 |     64.38% |    54.76GB |           2^30 |     1,615,299 |             0.15% |
|      12 |        1 |             140,243 |         0:00:11.52 |     56.78% |    27.38GB |           2^29 |         8,193 |             0.00% |
|      12 |        2 |       2,148,495,091 |         0:01:05.07 |     73.30% |    54.76GB |           2^30 |        92,737 |             0.01% |
|      13 |        1 |             402,956 |         0:00:26.28 |     60.12% |    54.76GB |           2^30 |         9,916 |             0.00% |
